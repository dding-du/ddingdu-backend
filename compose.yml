services:
  ddingdu-backend:
    image: 283784618786.dkr.ecr.ap-northeast-2.amazonaws.com/ddingdu-backend:latest
    container_name: ddingdu-backend
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      # === [DB & 기본 설정 (유지)] ===
      - SPRING_DATASOURCE_URL=${DB_URL}
      - SPRING_DATASOURCE_USERNAME=${DB_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD}
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=com.mysql.cj.jdbc.Driver
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
      - SPRING_JPA_SHOW_SQL=false

      # === [메일 설정 (유지)] ===
      - SPRING_MAIL_HOST=smtp.gmail.com
      - SPRING_MAIL_PORT=587
      - SPRING_MAIL_USERNAME=${GMAIL_USERNAME}
      - SPRING_MAIL_PASSWORD=${GMAIL_PASSWORD}
      - SPRING_MAIL_PROPERTIES_MAIL_SMTP_AUTH=true
      - SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_ENABLE=true

      # === [JWT 설정 (유지)] ===
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ACCESS_TOKEN_EXPIRATION=3600000
      - JWT_REFRESH_TOKEN_EXPIRATION=604800000

      # === [AI 관련 설정 (대거 삭제 및 변경)] ===
      # 삭제 대상 (더 이상 스프링이 안 씀):
      # - GOOGLE_API_KEY
      # - CHROMA_URL
      # - CHROMA_COLLECTION_ID
      # - GEMINI_API_MODEL
      # - GEMINI_SYSTEM_INSTRUCTION

      # [필수 추가] AI 서버(FastAPI) 주소
      # (이 주소로 HTTP 요청을 보내서 답변을 받아옵니다)
      - AI_SERVER_URL=http://ai-server:8000/chat
    depends_on:
      - ai-server
    networks:
      - ddingdu-network

  ai-server:
    build: ./ai-server  # 방금 만든 폴더를 빌드합니다
    container_name: ai-server
    ports:
      - "8000" # 내부 통신용 포트
    environment:
      - GOOGLE_API_KEY=${GEMINI_API_KEY}
    networks:
      - ddingdu-network

networks:
  ddingdu-network:
    driver: bridge